---
title: "Adversarial Simulation"
subtitle: "Strucutral after Measurement vs. vanilla SEM estimation - a case study on adversarial collaboration for simulation studies"
fig-cap-location: top
format:
  revealjs:
    center: true
    theme: default
    slide-number: c/t
    font-size: 12pt
engine: knitr
bibliography: ../../bibliography.bib
---
```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)

library(dplyr)
library(tidyr)
library(kableExtra)
library(ggplot2)
library(data.table)
library(dplyr)
library(tidyr)
library(ggh4x)


```


## Outline {auto-animate=true}
1. "Angry Science"
2. What is Adversarial Collaboration?
3. An Adversarial Simulation Framework

4. SAM vs. SEM
5. Collaboration and Results

## Angry Science


## Adversarial Collaboration


## An Adversarial Simulation Framework

::: {.r-fit-text}
| Steps of a Simulation Study | Content |
|-----------------|-----------------|
| <span class="fragment">1. Research Question</span>    | <span class="fragment">Verbal description of research goal (jointly)</span>    |
| <span class="fragment">2. Population Model</span>   | <span class="fragment">Type, size, complexity</span> |
| <span class="fragment">3. Data Generation</span>    | <span class="fragment">E.g. resampling vs. parametric draw</span>    |
| <span class="fragment">4. Experimental Design</span>    | <span class="fragment">Specifiy conditions (e.g. sample size)</span>    |
| <span class="fragment">5. Method Selection</span>   | <span class="fragment">Type, implementation, number</span>    |
| <span class="fragment">6. Estimands</span>    | <span class="fragment">Population level parameter values</span>    |
| <span class="fragment">7. Performance Metrics</span>    | <span class="fragment">E.g. Bias, Coverage etc.</span>  |
| <span class="fragment">8. Software</span>    | <span class="fragment">Applies to steps 2-7</span>    |
| <span class="fragment">9. Analysis</span>    | <span class="fragment">Decision criteria, graphical display etc.</span>  |
:::

## An Adversarial Simulation Framework

::: {.r-fit-text}
|                     | Round 1         | Round 2               | Round 1         |
|---------------------|:---------------:|:---------------------:|:---------------:|
| Steps         | Collaborator 1  | Joint Study           | Collaborator 2  |
| 1. Research Question|                |  Agreed upon prior to Round 1 |                |
| 2. Population Model |→                |                       |←                |
| 3. Data Generation  |→                |                       |←                |
| 4. Experimental Design|→              |                       |←                |
| 5. Method Selection |→                |                       |←                |
| 6. Estimands        |→                |                       |←                |
| 7. Performance Metrics|→             |                       |←                |
| 8. Software         |→                |                       |←                |
| 9. Analysis         |→                |                       |←                |
:::


## SAM vs SEM

## Collaboration and Results

## Round 1: Individual Studies 
| Kriegmair | Kosanke |
|-----------------|-----------------|
| based on @rosseel_structural_2022 and @dhaene_evaluation_2023 | based on @robitzsch_comparing_2022  |

## Studies by Kriegmair

## Study 1 <span style="font-size: 20px;">based on @rosseel_structural_2022</span>

::: {.r-fit-text}
::: {layout="[20,60,20]"}

::: {.column width="0%"}
:::

::: {.column width="60%"}

#### Population Models

::: {layout="[[1,1], [1,1]]" layout-valign="top"}

::: {.column width="50%" .fragment}
No Misspecifications
![](figures/model1_1.svg){width="60%"}
:::

::: {.column width="50%" .fragment}
Cross Loadings
![](figures/model1_2.svg){width="60%"}
:::

::: {.column width="50%" .fragment}
Correlated Residuals
![](figures/model1_3.svg){width="80%"}
:::

::: {.column width="50%" .fragment}
Structural Misspecification
![](figures/model1_4.svg){width="60%"}
:::
:::
:::

::: {.column width="35%" .fragment}
#### Other Conditions:

- N: 100, 400, 6400
- Indicator reliability: 0.3, 0.5, 0.7

#### Methods:

- Vanilla SEM
- Global SAM
- Local SAM
- Local SAM with unweighted least squares

#### Performance Metrics:
- Bias of path estimates
- RMSE of path estimates
- Coverage of 95% CI for path estimates

:::
:::
:::

## Study 2 <span style="font-size: 20px;">based on @dhaene_evaluation_2023</span>

::: {.r-fit-text}
::: {layout="[[45,10,10,35]]" layout-align="top"}

::: {.column width="45%"}
::: {layout="[[1,1]]" layout-valign="top"}

::: {.column width="50%" .fragment}
#### 2.1:

- No measurement misspecifications
- estimated paths absent in population

![](figures/model2_1.svg){width="100%"}
:::

::: {.column width="50%" .fragment}
#### 2.2:

- Estimated paths absent in population
- <span style="color: orange;">In exogenous analysis model</span>
- <span style="color: green;">In endogenous analysis model
![](figures/model2_2.svg){width="100%"}
:::
:::
:::
::: {.column width="7%"}
<!-- Empty column for space -->
:::

::: {.column width="35%"}
::: {.fragment}
#### Other Conditions:

- N: 100, 400, 6400
- Indicator reliability: 0.3, 0.5, 0.7
- **$R^2$: 0.1, 0.4**
- **Measurement blocks: 3, 5**
:::


:::{.fragment}
#### Methods:

- Vanilla SEM
- Global SAM
- Local SAM
- Local SAM with unweighted least squares

### Repetitions: 
- 10000
:::

:::
:::
:::

## Studies by Kosanke <span style="font-size: 20px;">based on @robitzsch_comparing_2022</span>

![](figures/kosanke_studies_overview.png)

# Results of individual studies:

## Convergence Rate
::: {.r-fit-text}
| | Kriegmair | Kosanke |
|---------------------|-----------|---------|
| Verbal Dispute |low convergence rate of SEM| no convergence issues |
|Method selection|un-bounded ML SEM |bounded ML SEM |
|Analysis| condition-wise rates | global rate |
|| direct:<br>`lavInspect(fit, "converged")` | indirect:<br>`quietly(safely(simulation_study_))`|
:::

## Convergence Rate <span style="font-size: 20px;"> E.g.: Kriegmair Study 1:</span>

![](tables/convergence_rate_study1.png)



## Bias
::: {.r-fit-text}
| | Kriegmair | Kosanke |
|------|-----------|---------|
| Verbal Dispute |"SEM performes worse than SAM in low reliability x low sample size x misspecification"| "SAM generally did not outperform traditional SEM in small to moderate samples." <br> <br> "[under] unmodelled negative cross-loadings and residual correlations, SAM tended to perform worse than traditional SEM"|
|4. Experimental Design| N:100-6400 <br> Reliability via Θ <br> Positive misspecifications| N:50-100000 <br> Reliability via $\lambda$ <br> Negative misspecification (only in CFA)|
|5. Population Model |5-factor-SEM | 2-factor CFA & 5-factor SEM |
|6. Analysis |aggregated absolute values and parameter-wise | aggregated absolute values & aggregated relative bias |
:::
:::{.notes}
In Kosanke’s results, SAM appears to perform worse than traditional SEM under unmodeled negative cross-loadings and residual correlations. This happens because of bias cancellation in LSAM, particularly in small samples.

LSAM tends to have a negative small-sample bias, and when you ignore positive residual correlations, that introduces a positive bias. These two biases can accidentally cancel each other out, making LSAM seem more accurate than it really is.

However, this is a false perception of robustness, as LSAM performs inconsistently across different conditions, and in cases like unmodeled negative correlations, it actually does worse than SEM. Kosanke's study shows that SAM doesn’t generally outperform traditional SEM in small to moderate samples, especially when negative biases are present.
:::

## Bias <span style="font-size: 20px;"> E.g.: Kriegmair Study 1:</span>

![](tables/aggregated_bias_study1.png)

<span style="font-size: 20px;">absolute bias values aggregated across parameters, in all conditions</span>

## Bias <span style="font-size: 20px;"> E.g.: Kosanke Study 1:</span>
::: {.r-fit-text}
```{r eval = TRUE, echo = FALSE}

# Load the relative bias results
bias_ci_s1 <- readRDS("../../LK/SimulationResultsProcessed/sim1_rel_bias_ci.rds")

shorten_names <- function(df) {
  df$method_metric <- sub("_rel_bias", "", df$method_metric)
  return(df)
}

# Function to create a styled table for each condition
create_styled_table <- function(data, condition) {
  data <- shorten_names(data)
  data <- data %>%
    mutate(across(where(is.numeric), ~ round(., 3)))
  
  # Format table
  kbl(data,
      col.names = c("Method", "50", "100", "250", "500", 
                    "1000", "2500", "100000"), booktabs = TRUE) %>%
    kable_styling(full_width = T, position = "left") %>%
    add_header_above(c(" " = 1, "Sample Size" = 7)) %>%
    column_spec(1, width = "3.5cm") %>% 
    row_spec(0, bold = TRUE) %>%
    kable_classic(full_width = F) %>%
    gsub("_", " ", .)
}
create_styled_table(bias_ci_s1[["2_-0.12"]], "2_-0.12")
```

<span style="font-size: 25px;">Relative bias in conditions with two negative unmodelled residual correlations in a 2-factor-CFA</span>

:::

## Collaboration
<div class="scrollable-table">
<table>
  <thead>
    <tr>
      <th></th>
      <th>Round 1</th>
      <th>Round 2</th>
      <th>Round 1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Steps</strong></td>
      <td>Kriegmair</td>
      <td>Joint Study</td>
      <td>Kosanke</td>
    </tr>
    <tr>
      <td><strong>1. Research Question</strong></td>
      <td></td>
      <td class="fragment round-2" data-fragment-index="0">Jointly agreed upon prior to round 1</td>
      <td></td>
    </tr>
    <tr>
      <td><strong>2. Population Model</strong></td>
      <td class="round-1" data-round="2"><span>5-factor-SEM</span></td>
      <td class="fragment round-2" data-fragment-index="1">5-factor-SEM</td>
      <td class="round-1" data-round="2"><span>5-factor-SEM</span> <span class="fragment fade-grey" data-fragment-index="1">2-factor-CFA</span></td>
    </tr>
    <tr>
      <td><strong>3. Data Generation</strong></td>
      <td class="round-1" data-round="3"><span>parametric & normally distributed</span></td>
      <td class="fragment round-2" data-fragment-index="2">parametric & normally distributed</td>
      <td class="round-1" data-round="3"><span>parametric & normally distributed</span></td>
    </tr>
    <tr>
      <td><strong>4. Experimental Design</strong></td>
      <td class="round-1" data-round="4">Misspecifications <br> N: 100 - 6400 <br> <span>Reliability via Θ</span></td>
      <td class="fragment round-2" data-fragment-index="3">Misspecifications <br> N: 50 - 100000 <br> Reliability via λ</td>
      <td class="round-1" data-round="4">Misspecifications <br> N: 50 - 100000 <br> Reliability via λ</td>
    </tr>
    <tr>
      <td><strong>5. Method Selection</strong></td>
      <td class="round-1" data-round="5">SEM, gSAM, lSAM <br> <span>(all ML)</span></td>
      <td class="fragment round-2" data-fragment-index="4">SEM, gSAM, lSAM <br> (ML & ULS)</td>
      <td class="round-1" data-round="5">SEM, gSAM, lSAM <br> (ML & ULS)</td>
    </tr>
    <tr>
      <td><strong>6. Estimands</strong></td>
      <td class="round-1" data-round="6"><span>β: Fixed at 0.1 or varied via R²</span></td>
      <td class="fragment round-2" data-fragment-index="5">β or φ: Fixed at 0.1 <br> or varied between 0.1 and 0.8</td>
      <td class="round-1" data-round="6">β or φ: Fixed at 0.1 <br> or varied between 0.1 and 0.8</td>
    </tr>
    <tr>
      <td><strong>7. Performance Metrics</strong></td>
      <td class="round-1" data-round="7"><span>Absolute & relative bias <br> RMSE</span> <span>95% CI coverage <br> Convergence & <br> Improper Solutions</span></td>
      <td class="fragment round-2" data-fragment-index="6">Absolute & relative bias <br> RMSE</td>
      <td class="round-1" data-round="7">Absolute & relative bias <br> RMSE</td>
    </tr>
    <tr>
      <td><strong>8. Software</strong></td>
      <td class="round-1" data-round="8"><span>lavaan::simulateData()</span></td>
      <td class="fragment round-2" data-fragment-index="7">lavaan::simulateData()</td>
      <td class="round-1" data-round="8">lavaan::simulateData()</td>
    </tr>
    <tr>
      <td><strong>9. Analysis</strong></td>
      <td class="round-1" data-round="9"><span>parameter-wise & <br> aggregated across parameters, heatmaps</span></td>
      <td class="fragment round-2" data-fragment-index="8">aggregated across, <br> tables, decision criteria</td>
      <td class="round-1" data-round="9">aggregated across, <br> tables, decision criteria</td>
    </tr>
  </tbody>
</table>
</div>

<style>
  .scrollable-table {
    max-height: 70vh;
    overflow-y: auto;
    font-size: 0.7em;
  }
  .scrollable-table table {
    border-collapse: collapse;
    width: 100%;
  }
  .scrollable-table th, .scrollable-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  .scrollable-table th {
    background-color: #f2f2f2;
    position: sticky;
    top: 0;
  }
  .fade-grey {
    color: #888;
    transition: color 0.5s ease;
  }
  .fade-bold {
    font-weight: bold;
    transition: font-weight 0.5s ease;
  }
  .hidden {
    display: none;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
  let round1Elements = document.querySelectorAll('.round-1');
  let round2Elements = document.querySelectorAll('.round-2');

  round1Elements.forEach((element, index) => {
    element.addEventListener('click', () => {
      let round = element.getAttribute('data-round');

      // Show corresponding Round 2 element
      round2Elements.forEach((round2Element) => {
        if (round2Element.getAttribute('data-fragment-index') === round) {
          round2Element.classList.remove('hidden');
        }
      });

      // Update the styling of Round 1 text (bold or grey)
      round1Elements.forEach((el) => {
        if (el.getAttribute('data-round') === round) {
          el.querySelectorAll('span').forEach(span => span.classList.add('fade-bold'));
        } else {
          el.querySelectorAll('span').forEach(span => span.classList.add('fade-grey'));
        }
      });
    });
  });
});
</script>
:::{.notes}
Adjusting the $\Theta$ matrix directly controls reliability by manipulating measurement error, aligning with its definition as the proportion of variance explained by the latent factor. Modulating $\lambda$ indirectly affects reliability but conflates factor strength with error variance, making it less precise in controlling reliability by definition.
:::





## References